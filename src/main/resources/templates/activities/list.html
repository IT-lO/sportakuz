<!DOCTYPE html>
<html lang="pl" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      th:replace="fragments :: base('Lista zajƒôƒá', ~{::content})">
<div th:fragment="content">
    <link rel="stylesheet" th:href="@{/css/lists.css}" />
<section>
    <div class="space-y-6">
        <!-- Nag≈Ç√≥wek sekcji z przyciskiem dodania nowego wystƒÖpienia -->
        <div class="flex items-center justify-between">
            <h1 class="text-3xl font-bold">Lista zajƒôƒá</h1>
            <div class="flex gap-3 items-center">
                <a sec:authorize="hasRole('ROLE_ADMIN')"
                   th:href="@{/panel/admin}"
                   class="text-sm text-red-600 hover:text-red-700 font-medium">
                    ‚Üê Powr√≥t do panelu
                </a>
                <a sec:authorize="hasRole('ROLE_INSTRUCTOR')"
                   th:href="@{/panel/instructor}"
                   class="text-sm text-green-600 hover:text-green-700 font-medium">
                    ‚Üê Powr√≥t do panelu
                </a>
                <a th:href="@{/activity-series}"
                   class="inline-flex items-center gap-2 px-4 py-2 rounded-md bg-indigo-600 text-white text-sm font-medium shadow-sm hover:bg-indigo-700 transition">
                    Serie
                </a>
                <!-- Przej≈õcie do formularza tworzenia nowych zajƒôƒá -->
                <a th:href="@{/activities/new}"
                   class="inline-flex items-center gap-2 px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-medium shadow-sm hover:bg-blue-700 transition">
                    <span class="text-lg leading-none">Ôºã</span> Nowe zajƒôcia
                </a>
            </div>
        </div>

            <!-- Flash: sukces / b≈ÇƒÖd -->
            <div th:if="${success}" class="flash-success" th:text="${success}"></div>
            <div th:if="${error}" class="flash-error" th:text="${error}"></div>

            <!-- Wyszukiwarka (server-side) -->
            <div class="table-tools">
                <form th:action="@{/activities}" method="get" class="search-box">
                    <input type="search" name="pattern" th:value="${pattern}"
                           placeholder="Szukaj po typie lub instruktorze" />
                    <label for="sort">Sortuj po:</label>
                    <select name="sort" id="sort">
                        <option value="" th:selected="${sort} == null or sort == ''">Domy≈õlnie</option>
                        <option value="type" th:selected="${sort} == 'type'">Typ</option>
                        <option value="instructor" th:selected="${sort} == 'instructor'">Instruktor</option>
                    </select>
                    <label for="order">Kolejno≈õƒá:</label>
                    <select name="order" id="order">
                        <option value="asc" th:selected="${order} == null or order == 'asc'">RosnƒÖco</option>
                        <option value="desc" th:selected="${order} == 'desc'">MalejƒÖco</option>
                    </select>
                    <button type="submit"
                            class="px-3 py-2 rounded-md bg-indigo-600 text-white text-sm hover:bg-indigo-700">Szukaj</button>
                    <a th:href="@{/activities}"
                       class="clear">Wyczy≈õƒá</a>
                </form>
            </div>

            <!-- Karta tabeli -->
            <div class="table-wrapper">
                <div class="table-responsive">
                    <table class="min-w-full text-sm">
                        <!-- Nag≈Ç√≥wek tabeli -->
                        <thead>
                        <tr>
                            <th class="px-4 py-3 text-left font-semibold">Data</th>
                            <th class="px-4 py-3 text-left font-semibold">Godziny</th>
                            <th class="px-4 py-3 text-left font-semibold">Typ</th>
                            <th class="px-4 py-3 text-left font-semibold">Instruktor</th>
                            <th class="px-4 py-3 text-left font-semibold">Sala</th>
                            <th class="px-4 py-3 text-left font-semibold">Pojemno≈õƒá</th>
                            <th class="px-4 py-3 text-left font-semibold">Rezerwacje</th>
                            <th class="px-4 py-3 text-left font-semibold">Status</th>
                            <th class="px-4 py-3 text-left font-semibold">Akcje</th>
                        </tr>
                        </thead>

                        <!-- Body -->
                        <tbody>
                        <tr th:each="c : ${activities}">
                            <!-- Data -->
                            <td class="px-4 py-3 whitespace-nowrap">
                                <span th:text="${#temporals.format(c.startTime, 'yyyy-MM-dd')}"></span>
                                <span th:if="${c.series != null}" th:title="${'Seria #' + c.series.id}">üîÅ</span>
                            </td>
                            <!-- Godziny -->
                            <td class="px-4 py-3 whitespace-nowrap"
                                th:text="${#temporals.format(c.startTime.atZoneSameInstant(T(java.time.ZoneId).of('Europe/Warsaw')), 'HH:mm')
                                          + ' - ' +
                                          #temporals.format(c.endTime.atZoneSameInstant(T(java.time.ZoneId).of('Europe/Warsaw')), 'HH:mm')}"></td>
                            <!-- Typ -->
                            <td class="px-4 py-3" th:text="${c.type.activityName}"></td>

                            <!-- Instruktor z dropdownem -->
                            <td class="px-4 py-3">
                                <div class="relative inline-block" th:attr="data-row-instr=${c.id}">
                                    <button type="button" data-instr-toggle th:attr="data-id=${c.id}"
                                            class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500"
                                            th:classappend="${c.substitutedFor != null} ? ' bg-orange-100 text-orange-900' : ' bg-gray-100 text-gray-900'"
                                            th:title="${c.substitutedFor != null ? 'Zastƒôpstwo za: ' + c.substitutedFor.firstName + ' ' + c.substitutedFor.lastName : ''}"
                                            th:text="${(c.substitutedFor != null ? '[Z] ' : '') + c.instructor.firstName + ' ' + c.instructor.lastName}">
                                    </button>

                                    <div class="hidden absolute left-0 mt-1 w-48 rounded-md border shadow-lg z-50 py-1 text-xs"
                                         data-instr-menu>
                                        <form th:each="i : ${availableInstructors[c.id]}"
                                              th:action="@{'/activities/' + ${c.id} + '/instructor'}"
                                              method="post" class="block">
                                            <input type="hidden" name="instructorId" th:value="${i.id}"/>

                                            <button type="submit"
                                                    class="w-full text-left px-3 py-1 flex items-center gap-1"
                                                    th:classappend="${i.id == c.instructor.id} ? ' font-semibold text-indigo-700' : ' text-gray-700'"
                                                    th:text="${i.firstName + ' ' + i.lastName}">
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </td>

                            <!-- Sala -->
                            <td class="px-4 py-3" th:text="${c.room.name}"></td>
                            <!-- Pojemno≈õƒá -->
                            <td class="px-4 py-3" th:text="${c.capacity}"></td>
                            <!-- Rezerwacje -->
                            <td class="px-4 py-3"
                                th:text="${activeBookings != null ? (activeBookings[c.id] != null ? activeBookings[c.id] : 0) : 0}">
                            </td>

                            <!-- Status -->
                            <td class="px-4 py-3">
                                <div class="relative inline-block" th:attr="data-row=${c.id}">
                                    <button type="button" data-status-toggle
                                            class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500"
                                            th:classappend="${c.status.name() == 'PLANNED' ? ' bg-yellow-100 text-yellow-800'
                                                          : (c.status.name() == 'CANCELLED' ? ' bg-red-100 text-red-700'
                                                          : (c.status.name() == 'FINISHED' ? ' bg-green-100 text-green-700'
                                                          : (c.status.name() == 'OPEN' ? ' bg-blue-100 text-blue-700'
                                                          : ' bg-gray-100 text-gray-700')))}"
                                            th:text="${c.status.label}">
                                    </button>

                                    <div class="hidden absolute left-0 mt-1 w-36 rounded-md border shadow-lg z-20 py-1 text-xs"
                                         data-status-menu>
                                        <form th:each="s : ${allStatuses}"
                                              th:action="@{'/activities/' + ${c.id} + '/status'}"
                                              method="post" class="block">
                                            <input type="hidden" name="status" th:value="${s}"/>

                                            <button type="submit"
                                                    class="w-full text-left px-3 py-1 flex items-center gap-1"
                                                    th:classappend="${s == c.status} ? ' font-semibold text-indigo-700' : ' text-gray-700'"
                                                    th:text="${s.label}">
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </td>

                            <!-- Akcje -->
                            <td class="px-4 py-3">
                                <div class="flex items-center gap-2">
                                    <a th:href="@{'/activities/' + ${c.id} + '/edit'}"
                                       class="inline-flex items-center px-2.5 py-1.5 rounded-md text-xs font-medium bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm">
                                        Edytuj
                                    </a>
                                    <form th:action="@{'/activities/' + ${c.id} + '/delete'}"
                                          method="post"
                                          th:object="${c}"
                                          class="inline"
                                          onsubmit="return confirm('UsunƒÖƒá zajƒôcia: ' + this.getAttribute('data-desc') + '?')"
                                          th:attr="data-desc=${#temporals.format(c.startTime,'yyyy-MM-dd') + ' ' + #temporals.format(c.startTime,'HH:mm') + '-' + #temporals.format(c.endTime,'HH:mm') + ' ' + c.room.name}">
                                        <button type="submit"
                                                th:disabled="${activeBookings != null ? (activeBookings[c.id] != null ? activeBookings[c.id] : 0) : 0} > 0"
                                                class="inline-flex items-center px-2.5 py-1.5 rounded-md text-xs font-medium shadow-sm"
                                                th:classappend="${(activeBookings != null ? (activeBookings[c.id] != null ? activeBookings[c.id] : 0) : 0) > 0}
                                                            ? ' bg-gray-300 text-gray-500 cursor-not-allowed'
                                                            : ' bg-red-600 text-white hover:bg-red-700'"
                                                th:title="${(activeBookings != null ? (activeBookings[c.id] != null ? activeBookings[c.id] : 0) : 0) > 0
                                                        ? 'Nie mo≈ºna usunƒÖƒá: aktywne rezerwacje'
                                                        : 'Usu≈Ñ zajƒôcia'}">
                                            Usu≈Ñ
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>

                        <!-- Wiersz ‚Äûbrak danych‚Äù -->
                        <tr th:if="${#lists.isEmpty(activities)}">
                            <td colspan="9" class="px-4 py-10 text-center muted">
                                Brak zajƒôƒá do wy≈õwietlenia.
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Paginacja dla listy g≈Ç√≥wnej (przysz≈Çe zajƒôcia) -->
            <div class="pagination-bar" th:if="${totalPages != null and totalPages > 1}">
                <a th:if="${page > 0}"
                   th:href="@{/activities(page=${page - 1}, pattern=${pattern}, sort=${sort}, order=${order})}"
                   class="page-link">
                    ‚Üê Poprzednia
                </a>
                <span class="page-info">
                    Strona [[${page + 1}]] z [[${totalPages}]]
                </span>
                <a th:if="${page + 1 < totalPages}"
                   th:href="@{/activities(page=${page + 1}, pattern=${pattern}, sort=${sort}, order=${order})}"
                   class="page-link">
                    Nastƒôpna ‚Üí
                </a>
            </div>

            <!-- Historia -->
            <div class="mt-12 space-y-4">
                <h2 class="text-xl font-semibold">Historia (anulowane / zako≈Ñczone)</h2>
                <div class="table-wrapper">
                    <div class="table-responsive">
                        <table class="min-w-full text-xs">
                            <thead>
                            <tr>
                                <th class="px-3 py-2 text-left font-semibold">Data</th>
                                <th class="px-3 py-2 text-left font-semibold">Godziny</th>
                                <th class="px-3 py-2 text-left font-semibold">Typ</th>
                                <th class="px-3 py-2 text-left font-semibold">Instruktor</th>
                                <th class="px-3 py-2 text-left font-semibold">Sala</th>
                                <th class="px-3 py-2 text-left font-semibold">Poj.</th>
                                <th class="px-3 py-2 text-left font-semibold">Status</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="c : ${historyActivities}">
                                <td class="px-3 py-2 whitespace-nowrap">
                                    <span th:text="${#temporals.format(c.startTime, 'yyyy-MM-dd')}"></span>
                                    <span th:if="${c.series != null}" th:title="${'Seria #' + c.series.id}">üîÅ</span>
                                </td>
                                <td class="px-3 py-2 whitespace-nowrap"
                                    th:text="${#temporals.format(c.startTime.atZoneSameInstant(T(java.time.ZoneId).of('Europe/Warsaw')), 'HH:mm')
                                              + ' - ' +
                                              #temporals.format(c.endTime.atZoneSameInstant(T(java.time.ZoneId).of('Europe/Warsaw')), 'HH:mm')}"></td>
                                <td class="px-3 py-2" th:text="${c.type.activityName}"></td>
                                <td class="px-3 py-2"
                                    th:text="${c.instructor.firstName + ' ' + c.instructor.lastName}"></td>
                                <td class="px-3 py-2" th:text="${c.room.name}"></td>
                                <td class="px-3 py-2" th:text="${c.capacity}"></td>
                                <td class="px-3 py-2">
                                <span class="inline-flex px-2 py-0.5 rounded-full text-[10px] font-semibold"
                                      th:classappend="${c.status.name() == 'CANCELLED'
                                                       ? ' bg-red-100 text-red-700'
                                                       : ' bg-green-100 text-green-700'}"
                                      th:text="${c.status.label}">
                                </span>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(historyActivities)}">
                                <td colspan="7" class="px-3 py-8 text-center muted">Brak pozycji w historii.</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </div>

        <!-- Skrypt dropdown√≥w / potwierdze≈Ñ -->
        <script>
            document.addEventListener('click', function (e) {
                if (e.target.matches('button[data-delete-id]')) {
                    const id = e.target.getAttribute('data-delete-id');
                    if (!confirm('UsunƒÖƒá zajƒôcia #' + id + '?')) {
                        e.preventDefault();
                    }
                }
            });
            document.addEventListener('click', function (e) {
                if (e.target.matches('[data-status-toggle]')) {
                    toggleMenu(e.target.closest('[data-row]'), '[data-status-menu]');
                    e.stopPropagation();
                } else if (e.target.matches('[data-instr-toggle]')) {
                    toggleMenu(e.target.closest('[data-row-instr]'), '[data-instr-menu]');
                    e.stopPropagation();
                } else if (!e.target.closest('[data-status-menu]') && !e.target.closest('[data-instr-menu]')) {
                    closeAllMenus();
                }
            });
            function toggleMenu(container, selector) {
                const menu = container.querySelector(selector);
                const open = !menu.classList.contains('hidden');
                if (selector === '[data-status-menu]') {
                    document.querySelectorAll('[data-status-menu]').forEach(m => hideMenu(m));
                } else if (selector === '[data-instr-menu]') {
                    document.querySelectorAll('[data-instr-menu]').forEach(m => hideMenu(m));
                }
                if (!open) {
                    showMenu(menu);
                } else {
                    hideMenu(menu);
                }
            }
            function showMenu(menu) {
                menu.classList.remove('hidden');
                menu.classList.remove('dropup');
                menu.style.top = '100%';
                menu.style.bottom = 'auto';
                const rect = menu.getBoundingClientRect();
                if (rect.bottom > window.innerHeight - 8) {
                    menu.classList.add('dropup');
                    menu.style.top = 'auto';
                    menu.style.bottom = '100%';
                }
            }
            function hideMenu(menu) {
                menu.classList.add('hidden');
                menu.classList.remove('dropup');
                menu.style.top = '';
                menu.style.bottom = '';
            }
            function closeAllMenus() {
                document.querySelectorAll('[data-status-menu], [data-instr-menu]').forEach(m => hideMenu(m));
            }
            window.addEventListener('resize', closeAllMenus);
            document.addEventListener('submit', function (e) {
                if (e.target.closest('[data-status-menu]') || e.target.closest('[data-instr-menu]')) {
                    closeAllMenus();
                }
            });
        </script>
        <style>
            [data-status-menu].dropup,
            [data-instr-menu].dropup {
                margin-top: 0;
                margin-bottom: .25rem;
            }
        </style>
    </section>
</div>
</html>
