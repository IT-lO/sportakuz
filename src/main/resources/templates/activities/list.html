<!DOCTYPE html>
<!-- Szablon listy wszystkich wystƒÖpie≈Ñ zajƒôƒá.
     U≈ºywa layoutu bazowego (fragments.html :: base) poprzez th:replace.
     Zawarto≈õƒá sekcji obejmuje nag≈Ç√≥wek, opcjonalny komunikat sukcesu, tabelƒô oraz skrypt z dodatkowym potwierdzeniem. -->
<html lang="pl" xmlns:th="http://www.thymeleaf.org" th:replace="~{fragments.html :: base('Lista zajƒôƒá', ~{::section})}">
<section>
    <div class="space-y-6">
        <!-- Nag≈Ç√≥wek sekcji z przyciskiem dodania nowego wystƒÖpienia -->
        <div class="flex items-center justify-between">
            <h1 class="text-3xl font-bold text-gray-900">Lista zajƒôƒá</h1>
            <div class="flex gap-3">
                <a th:href="@{/class-series}" class="inline-flex items-center gap-2 px-4 py-2 rounded-md bg-indigo-600 text-white text-sm font-medium shadow-sm hover:bg-indigo-700 transition">Serie</a>
                <!-- Przej≈õcie do formularza tworzenia nowych zajƒôƒá -->
                <a th:href="@{/activities/new}" class="inline-flex items-center gap-2 px-4 py-2 rounded-md bg-blue-600 text-white text-sm font-medium shadow-sm hover:bg-blue-700 transition">
                    <span class="text-lg leading-none">Ôºã</span> Nowe zajƒôcia
                </a>
            </div>
        </div>
        <!-- Komunikat sukcesu i b≈Çƒôdu (np. po zapisaniu / usuniƒôciu) renderowany warunkowo -->
        <div th:if="${success}" class="p-4 rounded-md bg-green-50 border border-green-200 text-green-800 text-sm" th:text="${success}"></div>
        <div th:if="${error}" class="p-4 rounded-md bg-red-50 border border-red-200 text-red-800 text-sm" th:text="${error}"></div>

        <!-- Karta tabeli z mo≈ºliwo≈õciƒÖ przewijania poziomego przy du≈ºej liczbie kolumn -->
        <div class="bg-white/90 backdrop-blur rounded-lg shadow-md border border-gray-200">
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <!-- Nag≈Ç√≥wek tabeli: kolumny podstawowych atrybut√≥w wystƒÖpienia -->
                    <thead class="bg-gray-50 text-gray-700 text-xs uppercase tracking-wider border-b border-gray-200">
                    <tr>
                        <th class="px-4 py-3 text-left font-semibold">Data</th>
                        <th class="px-4 py-3 text-left font-semibold">Godziny</th>
                        <th class="px-4 py-3 text-left font-semibold">Typ</th>
                        <th class="px-4 py-3 text-left font-semibold">Instruktor</th>
                        <th class="px-4 py-3 text-left font-semibold">Sala</th>
                        <th class="px-4 py-3 text-left font-semibold">Pojemno≈õƒá</th>
                        <th class="px-4 py-3 text-left font-semibold">Rezerwacje</th>
                        <th class="px-4 py-3 text-left font-semibold">Status</th>
                        <th class="px-4 py-3 text-left font-semibold">Akcje</th>
                    </tr>
                    </thead>
                    <!-- Body: iteracja po kolekcji 'activities'; ka≈ºdy wiersz reprezentuje jedno wystƒÖpienie -->
                    <tbody class="divide-y divide-gray-100">
                    <tr th:each="c : ${activities}" class="hover:bg-blue-50/40 transition">
                        <!-- Data rozpoczƒôcia + znacznik serii je≈õli wystƒÖpienie pochodzi z serii -->
                        <td class="px-4 py-3 whitespace-nowrap">
                            <span th:text="${#temporals.format(c.startTime, 'yyyy-MM-dd')}"></span>
                            <span th:if="${c.series != null}"  th:title="${'Seria #' + c.series.id}">üîÅ</span>
                        </td>
                        <!-- Godziny -->
                        <td class="px-4 py-3 whitespace-nowrap" th:text="${#temporals.format(c.startTime, 'HH:mm') + ' - ' + #temporals.format(c.endTime, 'HH:mm')}"></td>
                        <!-- Typ -->
                        <td class="px-4 py-3" th:text="${c.type.activityName}"></td>
                        <!-- Instruktor z dropdownem -->
                        <td class="px-4 py-3">
                            <div class="relative inline-block" th:attr="data-row-instr=${c.id}">
                                <button type="button" data-instr-toggle th:attr="data-id=${c.id}"
                                        class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500"
                                        th:classappend="${c.substitutedFor != null} ? ' bg-orange-100 text-orange-900' : ' bg-gray-100 text-gray-900'"
                                        th:title="${c.substitutedFor != null ? 'Zastƒôpstwo za: ' + c.substitutedFor.firstName + ' ' + c.substitutedFor.lastName : ''}"
                                        th:text="${(c.substitutedFor != null ? '[Z] ' : '') + c.instructor.firstName + ' ' + c.instructor.lastName}"></button>
                                <div class="hidden absolute left-0 mt-1 w-48 rounded-md border border-gray-200 bg-white shadow-lg z-50 py-1 text-xs" data-instr-menu>
                                    <form th:each="i : ${availableInstructors[c.getId()]}" th:action="@{'/activities/' + ${c.id} + '/instructor'}" method="post" class="block">
                                        <input type="hidden" name="instructorId" th:value="${i.id}" />
                                        <button type="submit" class="w-full text-left px-3 py-1 flex items-center gap-1 hover:bg-gray-100"
                                                th:classappend="${i.id == c.instructor.id} ? ' font-semibold text-indigo-700' : ' text-gray-700'"
                                                th:text="${i.firstName + ' ' + i.lastName}"></button>
                                    </form>
                                </div>
                            </div>
                        </td>
                        <!-- Nazwa sali -->
                        <td class="px-4 py-3" th:text="${c.room.name}"></td>
                        <!-- Pojemno≈õƒá (aktualna liczba miejsc) -->
                        <td class="px-4 py-3" th:text="${c.capacity}"></td>
                        <td class="px-4 py-3" th:text="${activeBookings != null ? (activeBookings[c.id] != null ? activeBookings[c.id] : 0) : 0}"></td>
                        <!-- STATUS -->
                        <td class="px-4 py-3">
                            <div class="relative inline-block" th:attr="data-row=${c.id}">
                                <button type="button" data-status-toggle
                                        class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold focus:outline-none focus:ring-2 focus:ring-offset-1 focus:ring-indigo-500"
                                        th:classappend="${c.status.name() == 'PLANNED' ? ' bg-yellow-100 text-yellow-800' : (c.status.name() == 'CANCELLED' ? ' bg-red-100 text-red-700' : (c.status.name() == 'FINISHED' ? ' bg-green-100 text-green-700' : (c.status.name() == 'OPEN' ? ' bg-blue-100 text-blue-700' : ' bg-gray-100 text-gray-700')))}"
                                        th:text="${c.status.label}"></button>
                                <div class="hidden absolute left-0 mt-1 w-36 rounded-md border border-gray-200 bg-white shadow-lg z-20 py-1 text-xs" data-status-menu>
                                    <form th:each="s : ${allStatuses}" th:action="@{'/activities/' + ${c.id} + '/status'}" method="post" class="block">
                                        <input type="hidden" name="status" th:value="${s}" />
                                        <button type="submit" class="w-full text-left px-3 py-1 hover:bg-gray-100 flex items-center gap-1"
                                                th:classappend="${s == c.status} ? ' font-semibold text-indigo-700' : ' text-gray-700'"
                                                th:text="${s.label}"></button>
                                    </form>
                                </div>
                            </div>
                        </td>
                        <!-- AKCJE -->
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                <a th:href="@{'/activities/' + ${c.id} + '/edit'}" class="inline-flex items-center px-2.5 py-1.5 rounded-md text-xs font-medium bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm">Edytuj</a>
                                <form th:action="@{'/activities/' + ${c.id} + '/delete'}" method="post" th:object="${c}" class="inline" onsubmit="return confirm('UsunƒÖƒá zajƒôcia: ' + this.getAttribute('data-desc') + '?')" th:attr="data-desc=${#temporals.format(c.startTime,'yyyy-MM-dd') + ' ' + #temporals.format(c.startTime,'HH:mm') + '-' + #temporals.format(c.endTime,'HH:mm') + ' ' + c.room.name}">
                                    <button type="submit" th:disabled="${activeBookings != null ? (activeBookings[c.id] != null ? activeBookings[c.id] : 0) : 0} > 0" class="inline-flex items-center px-2.5 py-1.5 rounded-md text-xs font-medium shadow-sm"
                                            th:classappend="${(activeBookings != null ? (activeBookings[c.id] != null ? activeBookings[c.id] : 0) : 0) > 0} ? ' bg-gray-300 text-gray-500 cursor-not-allowed' : ' bg-red-600 text-white hover:bg-red-700'"
                                            th:title="${(activeBookings != null ? (activeBookings[c.id] != null ? activeBookings[c.id] : 0) : 0) > 0 ? 'Nie mo≈ºna usunƒÖƒá: aktywne rezerwacje' : 'Usu≈Ñ zajƒôcia'}">Usu≈Ñ</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    <!-- Wiersz informujƒÖcy o braku danych gdy kolekcja pusta -->
                    <tr th:if="${#lists.isEmpty(activities)}">
                        <td colspan="9" class="px-4 py-10 text-center text-gray-500">Brak zajƒôƒá do wy≈õwietlenia.</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="mt-12 space-y-4">
            <h2 class="text-xl font-semibold text-gray-800">Historia (anulowane / zako≈Ñczone)</h2>
            <div class="bg-white/70 backdrop-blur rounded-lg shadow border border-gray-200">
                <div class="overflow-x-auto">
                    <table class="min-w-full text-xs">
                        <thead class="bg-gray-50 text-gray-600 uppercase tracking-wider border-b border-gray-200">
                        <tr>
                            <th class="px-3 py-2 text-left font-semibold">Data</th>
                            <th class="px-3 py-2 text-left font-semibold">Godziny</th>
                            <th class="px-3 py-2 text-left font-semibold">Typ</th>
                            <th class="px-3 py-2 text-left font-semibold">Instruktor</th>
                            <th class="px-3 py-2 text-left font-semibold">Sala</th>
                            <th class="px-3 py-2 text-left font-semibold">Poj.</th>
                            <th class="px-3 py-2 text-left font-semibold">Status</th>
                        </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">
                        <tr th:each="c : ${historyActivities}" class="hover:bg-gray-50 transition">
                            <td class="px-3 py-2 whitespace-nowrap">
                                <span th:text="${#temporals.format(c.startTime, 'yyyy-MM-dd')}"></span>
                                <span th:if="${c.series != null}"  th:title="${'Seria #' + c.series.id}">üîÅ</span>
                            </td>
                            <td class="px-3 py-2 whitespace-nowrap" th:text="${#temporals.format(c.startTime, 'HH:mm') + ' - ' + #temporals.format(c.endTime, 'HH:mm')}"></td>
                            <td class="px-3 py-2" th:text="${c.type.activityName}"></td>
                            <td class="px-3 py-2" th:text="${c.instructor.firstName + ' ' + c.instructor.lastName}"></td>
                            <td class="px-3 py-2" th:text="${c.room.name}"></td>
                            <td class="px-3 py-2" th:text="${c.capacity}"></td>
                            <td class="px-3 py-2">
                                <span class="inline-flex px-2 py-0.5 rounded-full text-[10px] font-semibold"
                                      th:classappend="${c.status.name() == 'CANCELLED' ? ' bg-red-100 text-red-700' : ' bg-green-100 text-green-700'}"
                                      th:text="${c.status.label}"></span>
                            </td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(historyActivities)}">
                            <td colspan="7" class="px-3 py-8 text-center text-gray-400">Brak pozycji w historii.</td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- Skrypt: dodatkowe (awaryjne) potwierdzenie usuniƒôcia gdyby inline onsubmit nie zadzia≈Ça≈Ç.
         Nas≈Çuchuje klikniƒôƒá na przyciskach oznaczonych data-delete-id (obecnie brak takiego atrybutu ‚Äì pozostawione). -->
    <script>
        // Rezerwowe potwierdzenie usuniƒôcia (pozostawione)
        document.addEventListener('click', function(e){
            if(e.target.matches('button[data-delete-id]')){
                const id = e.target.getAttribute('data-delete-id');
                if(!confirm('UsunƒÖƒá zajƒôcia #' + id + '?')){
                    e.preventDefault();
                }
            }
        });
        // Jeden wsp√≥lny mechanizm dla dropdown√≥w (status + instruktor)
        document.addEventListener('click', function(e){
            if(e.target.matches('[data-status-toggle]')){
                toggleMenu(e.target.closest('[data-row]'), '[data-status-menu]');
                e.stopPropagation();
            } else if(e.target.matches('[data-instr-toggle]')){
                toggleMenu(e.target.closest('[data-row-instr]'), '[data-instr-menu]');
                e.stopPropagation();
            } else if(!e.target.closest('[data-status-menu]') && !e.target.closest('[data-instr-menu]')) {
                closeAllMenus();
            }
        });
        function toggleMenu(container, selector){
            const menu = container.querySelector(selector);
            const open = !menu.classList.contains('hidden');
            if(selector === '[data-status-menu]'){
                // zamknij tylko statusy
                document.querySelectorAll('[data-status-menu]').forEach(m => hideMenu(m));
            } else if(selector === '[data-instr-menu]'){
                document.querySelectorAll('[data-instr-menu]').forEach(m => hideMenu(m));
            }
            if(!open){
                showMenu(menu);
            } else {
                hideMenu(menu);
            }
        }
        function showMenu(menu){
            menu.classList.remove('hidden');
            menu.classList.remove('dropup');
            menu.style.top = '100%';
            menu.style.bottom = 'auto';
            // Dropup je≈õli za nisko
            const rect = menu.getBoundingClientRect();
            if(rect.bottom > window.innerHeight - 8){
                menu.classList.add('dropup');
                menu.style.top = 'auto';
                menu.style.bottom = '100%';
            }
        }
        function hideMenu(menu){
            menu.classList.add('hidden');
            menu.classList.remove('dropup');
            menu.style.top=''; menu.style.bottom='';
        }
        function closeAllMenus(){
            document.querySelectorAll('[data-status-menu], [data-instr-menu]').forEach(m => hideMenu(m));
        }
        window.addEventListener('resize', closeAllMenus);
        document.addEventListener('submit', function(e){
            if(e.target.closest('[data-status-menu]') || e.target.closest('[data-instr-menu]')){
                closeAllMenus();
            }
        });
    </script>
    <style>
        [data-status-menu].dropup, [data-instr-menu].dropup { margin-top:0; margin-bottom:.25rem; }
    </style>
</section>
</html>
