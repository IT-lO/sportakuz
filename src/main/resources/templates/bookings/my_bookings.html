<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pl" th:replace="~{fragments :: base('Moje Rezerwacje', ~{::content})}">
<div th:fragment="content">
    <link rel="stylesheet" th:href="@{/css/my_bookings.css}" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        window.__bookings = /*[[${bookings}]]*/ [];
        /*]]>*/
    </script>

    <div class="container">
        <div class="header" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1 id="mainTitle" th:text="${pageTitle != null} ? ${pageTitle} : 'Moje rezerwacje'"></h1>
                <p>Twoje aktywne rezerwacje</p>
            </div>
            <button id="downloadPdfBtn" class="pdf-button" onclick="generatePDF()">
                 Pobierz PDF
            </button>
        </div>

        <div class="reservations-list" id="reservationsList">
            <div th:if="${#lists.isEmpty(bookings)}" class="empty-state">
                <div class="empty-icon"></div>
                <h3>Brak aktywnych rezerwacji</h3>
                <p>Nie masz obecnie 偶adnych zarezerwowanych zaj sportowych.</p>
            </div>
            <div th:each="b : ${bookings}" class="reservation-card" th:attr="data-booking-id=${b.id}">
                <button class="cancel-button no-print" type="button"
                        th:attr="data-activity=${b.activityName}"
                        onclick="BookingsPage.showCancelModal(this)">Anuluj rezerwacj</button>

                <div class="activity-name" th:text="${b.activityName}">Nazwa zaj</div>
                <div class="reservation-details">
                    <div class="detail-item">
                        <span class="detail-label">Instruktor:</span>
                        <span class="detail-value instructor-name"
                              th:if="${b.isSubstitution}"
                              th:utext="'&lt;s&gt;' + ${b.instructor} + '&lt;/s&gt;'">Instruktor</span>
                        <span class="detail-value instructor-name"
                              th:unless="${b.isSubstitution}"
                              th:text="${b.instructor}">Instruktor</span>
                    </div>
                    <div class="detail-item" th:if="${b.isSubstitution}" ><span class="detail-label">Zastpstwo:</span> <span class="detail-value instructor-name" th:text="${b.substitutedFor}">Instruktor</span></div>
                    <div class="detail-item"><span class="detail-label">Data:</span> <span class="detail-value" th:text="${b.date}">Data</span></div>
                    <div class="detail-item"><span class="detail-label">Godzina:</span> <span class="detail-value" th:text="${b.time}">Godzina</span></div>
                    <div class="detail-item"><span class="detail-label">Czas trwania:</span> <span class="detail-value" th:text="${b.duration}">60 minut</span></div>
                    <div class="detail-item"><span class="detail-label">Sala:</span> <span class="detail-value" th:text="${b.room}">Sala</span></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="cancelModal">
        <div class="modal-content">
            <div class="modal-title">Anulowanie rezerwacji</div>
            <div class="modal-message" id="modalMessage">Czy na pewno chcesz anulowa t rezerwacj?</div>
            <div class="modal-buttons">
                <button class="modal-button confirm-button" type="button" onclick="BookingsPage.confirmCancel()">Tak, anuluj</button>
                <button class="modal-button cancel-modal-button" type="button" onclick="BookingsPage.closeCancelModal()">Nie, zostaw</button>
            </div>
        </div>
    </div>

    <script th:src="@{/js/my_bookings.js}"></script>

    <script>
        function generatePDF() {
            // Pobieramy element do wydruku
            const element = document.getElementById('reservationsList');

            // Konfiguracja PDF
            const opt = {
                margin:       [10, 10, 10, 10], // Marginesy: g贸ra, lewo, d贸, prawo
                filename:     'moje_rezerwacje.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true }, // scale: 2 poprawia jako tekstu
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // Hack: Klonujemy element, aby usun przyciski "Anuluj" tylko z wydruku,
            // nie zmieniajc widoku na ekranie.
            const elementClone = element.cloneNode(true);

            // Usu przyciski anulowania z klona
            const buttons = elementClone.querySelectorAll('.cancel-button');
            buttons.forEach(btn => btn.remove());

            // (Opcjonalnie) Dodaj nag贸wek do PDF wewntrz klona
            const header = document.createElement('h2');
            header.innerText = 'Potwierdzenie Rezerwacji Sportakuz';
            header.style.textAlign = 'center';
            header.style.marginBottom = '20px';
            header.style.fontFamily = 'Arial, sans-serif';
            elementClone.insertBefore(header, elementClone.firstChild);

            // Generuj PDF z klona
            html2pdf().set(opt).from(elementClone).save();
        }
    </script>

    <script>
        function generatePDF() {
            const element = document.getElementById('reservationsList');

            const opt = {
                margin:       [10, 10, 10, 10],
                filename:     'moje_rezerwacje.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            // 1. Klonujemy element
            const elementClone = element.cloneNode(true);

            // --- SEKCJA EDYCJI WYGLDU DLA PDF ---

            // 2. Usuwamy przyciski (tak jak wczeniej)
            const buttons = elementClone.querySelectorAll('.cancel-button');
            buttons.forEach(btn => btn.remove());

            // 3. Zmieniamy kolory kart (Zwikszamy kontrast)
            const cards = elementClone.querySelectorAll('.reservation-card');
            cards.forEach(card => {
                // Ustawiamy biae to i wyra藕n ramk (styl "dokumentowy")
                card.style.backgroundColor = '#ffffff';
                card.style.border = '1px solid #333333';
                card.style.color = '#000000'; // Wymu czarny tekst
                card.style.boxShadow = 'none'; // Usu cienie, w PDF wygldaj sabo
                card.style.marginBottom = '10px'; // Odstp midzy kartami
                card.style.padding = '15px';
            });

            // 4. Poprawiamy czytelno etykiet (np. "Data:", "Instruktor:")
            const labels = elementClone.querySelectorAll('.detail-label');
            labels.forEach(label => {
                label.style.color = '#333333'; // Ciemnoszary zamiast wyblakego
                label.style.fontWeight = 'bold';
            });

            // 5. Poprawiamy czytelno wartoci (np. konkretna data, nazwisko)
            const values = elementClone.querySelectorAll('.detail-value');
            values.forEach(val => {
                val.style.color = '#000000'; // Czysta czer
            });

            // 6. Nag贸wek i inne napisy
            const titles = elementClone.querySelectorAll('.activity-name');
            titles.forEach(title => {
                title.style.color = '#000000';
                title.style.borderBottom = '1px solid #ccc'; // Dodatkowa linia oddzielajca
                title.style.paddingBottom = '5px';
            });

            // -------------------------------------

            // Dodanie nag贸wka PDF
            const header = document.createElement('h2');
            header.innerText = 'Potwierdzenie Rezerwacji - Lista';
            header.style.textAlign = 'center';
            header.style.color = '#000';
            header.style.fontFamily = 'Arial, sans-serif';
            header.style.marginBottom = '20px';
            elementClone.insertBefore(header, elementClone.firstChild);

            // Generowanie
            html2pdf().set(opt).from(elementClone).save();
        }
    </script>
</div>
</html>