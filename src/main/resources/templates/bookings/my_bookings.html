<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{fragments :: base(#{my.bookings.title}, ~{::content})}">

<div th:fragment="content">
    <link rel="stylesheet" th:href="@{/css/my_bookings.css}" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <script th:inline="javascript">
        /*<![CDATA[*/
        window.__bookings = /*[[${bookings}]]*/ [];

        window.__locale = /*[[${#locale.language}]]*/ 'pl';

        const pdfTranslations = {
            filename: /*[[#{my.bookings.pdf.filename}]]*/ 'moje_rezerwacje.pdf',
            header: /*[[#{my.bookings.pdf.header}]]*/ 'Potwierdzenie Rezerwacji'
        };
        /*]]>*/
    </script>

    <div class="container">
        <div class="header" style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1 id="mainTitle" th:text="${pageTitle != null} ? ${pageTitle} : #{my.bookings.title}">Moje rezerwacje</h1>
                <p th:text="#{my.bookings.subtitle}">Twoje aktywne rezerwacje</p>
            </div>
            <button id="downloadPdfBtn" class="pdf-button" onclick="generatePDF()">
                ðŸ“¥ <span th:text="#{my.bookings.btn.pdf}">Pobierz PDF</span>
            </button>
        </div>

        <div class="reservations-list" id="reservationsList">

            <div th:if="${#lists.isEmpty(bookings)}" class="empty-state">
                <div class="empty-icon">ðŸ“…</div>
                <h3 th:text="#{my.bookings.empty.title}">Brak aktywnych rezerwacji</h3>
                <p th:text="#{my.bookings.empty.desc}">Nie masz obecnie Å¼adnych zarezerwowanych zajÄ™Ä‡ sportowych.</p>
            </div>

            <div th:each="b : ${bookings}" class="reservation-card" th:attr="data-booking-id=${b.id}">
                <button class="cancel-button no-print" type="button"
                        th:attr="data-activity=${b.activityName}"
                        onclick="BookingsPage.showCancelModal(this)"
                        th:text="#{my.bookings.btn.cancel}">Anuluj rezerwacjÄ™</button>

                <div class="activity-name" th:text="${b.activityName}">Nazwa zajÄ™Ä‡</div>

                <div class="reservation-details">
                    <div class="detail-item">
                        <span class="detail-label" th:text="#{my.bookings.label.instructor}">Instruktor:</span>
                        <span class="detail-value instructor-name"
                              th:if="${b.isSubstitution}"
                              th:utext="'&lt;s&gt;' + ${b.instructor} + '&lt;/s&gt;'">Instruktor</span>
                        <span class="detail-value instructor-name"
                              th:unless="${b.isSubstitution}"
                              th:text="${b.instructor}">Instruktor</span>
                    </div>

                    <div class="detail-item" th:if="${b.isSubstitution}">
                        <span class="detail-label" th:text="#{my.bookings.label.substitution}">ZastÄ™pstwo:</span>
                        <span class="detail-value instructor-name" th:text="${b.substitutedFor}">Instruktor</span>
                    </div>

                    <div class="detail-item">
                        <span class="detail-label" th:text="#{my.bookings.label.date}">Data:</span>
                        <span class="detail-value" th:text="${b.date}">Data</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label" th:text="#{my.bookings.label.time}">Godzina:</span>
                        <span class="detail-value" th:text="${b.time}">Godzina</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label" th:text="#{my.bookings.label.duration}">Czas trwania:</span>
                        <span class="detail-value" th:text="${b.duration} + ' min'">60 min</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label" th:text="#{my.bookings.label.room}">Sala:</span>
                        <span class="detail-value" th:text="${b.room}">Sala</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="cancelModal">
        <div class="modal-content">
            <div class="modal-title" th:text="#{my.bookings.modal.title}">Anulowanie rezerwacji</div>
            <div class="modal-message" id="modalMessage" th:text="#{my.bookings.modal.msg}">Czy na pewno chcesz anulowaÄ‡ tÄ™ rezerwacjÄ™?</div>
            <div class="modal-buttons">
                <button class="modal-button confirm-button" type="button"
                        onclick="BookingsPage.confirmCancel()"
                        th:text="#{my.bookings.modal.yes}">Tak, anuluj</button>
                <button class="modal-button cancel-modal-button" type="button"
                        onclick="BookingsPage.closeCancelModal()"
                        th:text="#{my.bookings.modal.no}">Nie, zostaw</button>
            </div>
        </div>
    </div>

    <script th:src="@{/js/my_bookings.js}"></script>

    <script>
        function generatePDF() {
            const element = document.getElementById('reservationsList');

            const opt = {
                margin:       [10, 10, 10, 10],
                filename:     pdfTranslations.filename,
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2, useCORS: true },
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };

            const elementClone = element.cloneNode(true);
            const buttons = elementClone.querySelectorAll('.cancel-button');
            buttons.forEach(btn => btn.remove());

            const cards = elementClone.querySelectorAll('.reservation-card');
            cards.forEach(card => {
                card.style.backgroundColor = '#ffffff';
                card.style.border = '1px solid #333333';
                card.style.color = '#000000';
                card.style.boxShadow = 'none';
                card.style.marginBottom = '10px';
                card.style.padding = '15px';
            });

            const labels = elementClone.querySelectorAll('.detail-label');
            labels.forEach(label => {
                label.style.color = '#333333';
                label.style.fontWeight = 'bold';
            });

            const values = elementClone.querySelectorAll('.detail-value');
            values.forEach(val => {
                val.style.color = '#000000';
            });

            const titles = elementClone.querySelectorAll('.activity-name');
            titles.forEach(title => {
                title.style.color = '#000000';
                title.style.borderBottom = '1px solid #ccc';
                title.style.paddingBottom = '5px';
            });

            const header = document.createElement('h2');
            header.innerText = pdfTranslations.header;
            header.style.textAlign = 'center';
            header.style.color = '#000';
            header.style.fontFamily = 'Arial, sans-serif';
            header.style.marginBottom = '20px';
            elementClone.insertBefore(header, elementClone.firstChild);

            html2pdf().set(opt).from(elementClone).save();
        }
    </script>
</div>
</html>